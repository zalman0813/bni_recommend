# LINE 整合

## Rich Menu 配置

```
┌─────────────┬─────────────┬─────────────┐
│    🛒      │    📋      │    🛍️      │
│  我要下單   │  我的訂單   │  購物車     │
├─────────────┼─────────────┼─────────────┤
│    📦      │    ❓      │    📞      │
│  商品總覽   │  使用說明   │  團購資訊   │
└─────────────┴─────────────┴─────────────┘
```

### 按鈕動作設定

| 按鈕 | 動作類型 | 動作內容 | 說明 |
|------|---------|---------|------|
| 我要下單 | URI | `https://liff.line.me/{LIFF_ID}` | 開啟 LIFF 商品列表 |
| 我的訂單 | URI | `https://liff.line.me/{LIFF_ID}/orders` | 開啟 LIFF 訂單頁 |
| 購物車 | URI | `https://liff.line.me/{LIFF_ID}/cart` | 開啟 LIFF 購物車 |
| 商品總覽 | Postback | `action=products` | 發送商品 Carousel |
| 使用說明 | Postback | `action=help` | 發送使用教學 Flex |
| 團購資訊 | Postback | `action=info` | 顯示取貨/付款資訊 |

### Rich Menu 圖片規格
- **尺寸**：2500x1686 px（大型6格）
- **風格**：團購/購物風格，清爽配色
- **設定方式**：透過 LINE Official Account Manager 或 Messaging API

---

## Webhook 事件處理

| 事件類型 | 處理邏輯 |
|---------|---------|
| `follow` | 取得用戶資訊 → 儲存到資料庫 → 發送歡迎 Flex Message |
| `postback` | 解析 action 參數 → 回覆對應 Flex Message |
| `message` (text) | 關鍵字偵測 → 回覆對應訊息 |

### Postback 動作對應

| Action | 回應 |
|--------|------|
| `action=products` | 商品總覽 Carousel（查詢上架商品） |
| `action=help` | 使用說明 Flex Message |
| `action=info` | 團購資訊 Flex Message |

### 關鍵字對應

| 關鍵字 | 回應 |
|--------|------|
| 下單、購物 | 導向 LIFF 購物頁 |
| 訂單、查詢 | 導向 LIFF 訂單頁 |
| 說明、幫助 | 使用說明 Flex Message |
| 商品、總覽 | 商品總覽 Carousel |
| 團購、資訊 | 團購資訊 Flex Message |

---

## Flex Message 類型

| 類型 | 函式名稱 | 觸發時機 |
|------|---------|---------|
| 歡迎訊息 | `createWelcomeMessage()` | 用戶加好友 (Follow) |
| 商品總覽 | `createProductCarouselMessage()` | Postback `action=products` |
| 使用說明 | `createHelpMessage()` | Postback `action=help` |
| 團購資訊 | `createInfoMessage()` | Postback `action=info` |
| 訂單確認 | `createOrderConfirmationMessage()` | 用戶下單後 |
| 到貨通知 | `createArrivalNotificationMessage()` | 後台發送通知 |
| 狀態更新 | `createStatusUpdateMessage()` | 訂單狀態變更 |

### 歡迎訊息

```
┌─────────────────────────┐
│  🎉 歡迎加入團購！       │ (綠底)
├─────────────────────────┤
│ 嗨 {用戶名稱}！          │
│ 歡迎加入團購智慧管家     │
│ 點擊下方選單開始選購吧！ │
├─────────────────────────┤
│ [立即選購]  [使用說明]   │
└─────────────────────────┘
```

### 商品總覽 Carousel

```
[商品卡1] → [商品卡2] → [商品卡3] → ...

每張卡片：
┌─────────────────┐
│   [商品圖片]    │
├─────────────────┤
│ 商品名稱        │
│ $價格           │
│ 庫存：10        │
├─────────────────┤
│  [前往選購]     │
└─────────────────┘
```

### 使用說明

```
┌─────────────────────────┐
│  📖 團購使用說明         │ (藍底)
├─────────────────────────┤
│ ① 點選「我要下單」      │
│    瀏覽商品並加入購物車  │
│ ② 前往購物車送出訂單    │
│ ③ 等待到貨通知          │
│ ④ 依通知前往取貨付款    │
├─────────────────────────┤
│    [立即選購]           │
└─────────────────────────┘
```

### 團購資訊

```
┌─────────────────────────┐
│  📋 團購資訊            │ (綠底)
├─────────────────────────┤
│ 📍 取貨地點：請洽團主   │
│ 🕐 取貨時間：到貨後通知 │
│ 💰 付款方式：現金付款   │
│ 📞 聯絡團主：直接留言   │
├─────────────────────────┤
│    [我要下單]           │
└─────────────────────────┘
```

### 訂單確認訊息

```
┌─────────────────────────┐
│    ✅ 訂單已成立        │ (綠底)
├─────────────────────────┤
│ 訂單編號: xxx           │
│ ─────────────────────── │
│ 商品名稱 x 數量         │
│ ─────────────────────── │
│ 訂單金額:         $xxx  │
├─────────────────────────┤
│    [查看我的訂單]       │
└─────────────────────────┘
```

### 到貨通知訊息

```
┌─────────────────────────┐
│    📦 商品已到貨        │ (綠底)
├─────────────────────────┤
│ 您的團購商品已到貨      │
│ ─────────────────────── │
│ 商品名稱 x 數量         │
│ ─────────────────────── │
│ 應付金額:         $xxx  │
├─────────────────────────┤
│    [查看我的訂單]       │
└─────────────────────────┘
```

### 訂單狀態更新

```
┌─────────────────────────┐
│  📦 訂單狀態更新         │ (藍底)
├─────────────────────────┤
│ 訂單 #ABC123            │
│ 狀態：已確認 ✅          │
│ 您的訂單已確認...       │
├─────────────────────────┤
│    [查看訂單]           │
└─────────────────────────┘
```

---

## 相關檔案

| 檔案路徑 | 說明 |
|---------|------|
| `src/lib/line/client.ts` | LINE Bot SDK 封裝 |
| `src/lib/line/webhook.ts` | 簽名驗證、事件類型守衛 |
| `src/lib/line/flex-messages.ts` | Flex Message 建構器 |
| `src/lib/line/liff.ts` | LIFF SDK 封裝 |
| `src/app/api/webhook/route.ts` | Webhook 路由處理 |
| `src/app/api/notify/arrived/route.ts` | 到貨通知 API |

---

## SDK 工具函數

### LINE Bot Client (`src/lib/line/client.ts`)

| 函數 | 用途 |
|------|------|
| `getUserProfile(userId)` | 取得用戶個資 |
| `pushMessage(userId, messages)` | 推送訊息 |
| `replyMessage(token, messages)` | 回覆訊息 |
| `getLineClient()` | 取得 Bot 客戶端實例 |

### LIFF (`src/lib/line/liff.ts`)

| 函數 | 用途 |
|------|------|
| `initializeLiff()` | 初始化 LIFF SDK |
| `isInLiffClient()` | 檢查是否在 LINE 內 |
| `isLoggedIn()` | 檢查登入狀態 |
| `login() / logout()` | 登入/登出 |
| `getProfile()` | 取得用戶個資 |
| `closeLiff()` | 關閉 LIFF 視窗 |
