
# 專案規格書：BNI 引薦回報自動化系統 (LINE Bot + GAS)

## 1. 專案概述

本系統旨在透過 LINE 官方帳號（Messaging API）自動化收集 BNI 小組成員的每週引薦數據。系統利用對話式介面引導回報，將數據儲存於 Google Sheets，並依據使用者身分（組員/組長）提供分流功能選單。資料存儲採用「每週一分頁」的動態管理模式。

## 2. 系統架構

* **前端介面：** LINE Messaging API (Flex Message / Rich Menu)。
* **後端邏輯：** Google Apps Script (GAS)。
* **資料庫：** Google Sheets (Google 試算表)。

---

## 3. 資料庫設計 (Google Sheets)

試算表將由「一張固定的成員表」與「每週自動新增的週報表」組成。

### 3.1 固定分頁：`Member_List` (成員清單)

此分頁用於管理權限與綁定狀態，不可刪除或更名。

| 欄位名稱 | 說明 | 範例數據 |
| --- | --- | --- |
| **LINE用戶ID** | LINE 唯一識別碼 (Key) | `U12345abcde...` |
| **真實姓名** | 真實姓名 | `暖樺` |
| **小組名稱** | 所屬小組 | `活力組` |
| **角色** | 權限角色 | `組長` / `幹部` / `組員` |
| **狀態** | 帳號狀態 | `啟用` / `停用` |

### 3.2 固定分頁：`Group_List` (小組清單)

此分頁用於管理小組列表，新增小組名稱即可。

| 欄位名稱 | 說明 | 範例數據 |
| --- | --- | --- |
| **小組名稱** | 小組名稱 | `活力組` |

### 3.3 動態分頁：`YYYY-Www` (週報表)

* **命名規則：** 依據 ISO 週數命名，例如 `2024-W12`。
* **生成邏輯：** 當該週第一筆回報產生時，系統自動建立新分頁，並插入至 **Index 0 (最左側)**，方便開啟即視。
* **欄位結構：**

| 欄 (Col) | 欄位名稱 (Header) | 說明 |
| --- | --- | --- |
| **A** | **更新時間** | 最後更新時間 (yyyy/MM/dd HH:mm:ss) |
| **B** | **小組名稱** | 成員所屬小組 |
| **C** | **成員姓名** | 成員姓名 |
| **D** | **內部引薦** | 內部引薦張數 (Number) |
| **E** | **內部備註** | 內部引薦對象 (String) |
| **F** | **外部引薦** | 外部引薦張數 (Number) |
| **G** | **外部備註** | 外部引薦對象 (String) |
| **H** | **總金額** | 內外總金額 (Number) |
| **I** | **121次數** | 1對1 次數 (Number) |

---

## 4. 使用者介面與選單 (Rich Menu)

系統需向 LINE 註冊三張 Rich Menu，並根據 `Member_List` 的狀態動態綁定。

### 4.1 未註冊選單 (Menu_Unbound)

* **觸發條件：** User ID 不在 `Member_List` 中。
* **按鈕配置：**
1. **【啟動姓名綁定】**：觸發註冊對話流。



### 4.2 組員選單 (Menu_Member)

* **觸發條件：** 已綁定且「角色 = 組員」。
* **按鈕配置：**
1. **【我要回報】**：觸發回報問答流。
2. **【查看本週數據】**：觸發個人回報摘要查詢。



### 4.3 組長選單 (Menu_Leader)

* **觸發條件：** 已綁定且「角色 = 組長」或「角色 = 幹部」。
* **按鈕配置：**
1. **【我要回報】**：同組員功能。
2. **【查看本週數據】**：同組員功能。
3. **【本週已回報】**：(管理) 列出詳細回報清單。
4. **【本週未回報】**：(管理) 列出未填寫者名單。
5. **【雲端總覽】**：(連結) 開啟 Google Sheets 網址。



---

## 5. 核心功能邏輯

### 5.1 時間管制機制

* **開放時段：** 每週四 06:00 開啟。
* **關閉時段：** 每週三 23:00 關閉。
* **阻擋訊息：** 若在非開放時段點擊「我要回報」，系統回覆：
> 「🚫 目前非回報時段。請於 **週四 06:00 至 週三 23:00** 之間進行回報。」



### 5.2 引薦回報對話流 (State Machine)

當用戶點擊「我要回報」且在開放時間內，機器人依序詢問：

1. **Q1:** 請問本週 **內部引薦** 張數？ (僅數字)
2. **Q2:** 請問內部引薦是給哪些夥伴？ (文字，例：給張大為)
3. **Q3:** 請問本週 **外部引薦** 張數？ (僅數字)
4. **Q4:** 請問外部引薦是給哪些對象？ (文字，例：蜂蜜禮盒/浩倫)
5. **Q5:** 請問本週 **內外總金額**？ (僅數字)
6. **Q6:** 請問本週 **1對1 (121)** 次數？ (僅數字)

* **資料寫入規則 (Upsert)：**
* 系統檢查當週分頁 (`YYYY-Www`) 是否存在，若無則建立。
* 在該分頁搜尋該使用者的名字。
* **若存在：** 更新該列數據 (Overwrite)。
* **若不存在：** 新增一列數據 (Append)。



### 5.3 回報結束：個人摘要生成 (Summary Logic)

流程結束或點擊「查看本週數據」時，系統依以下邏輯組裝訊息：

**【顯示邏輯判斷】**

* **引薦區塊：**
* 若 (內>0, 外>0)：顯示兩行。
* 若 (內>0, 外=0)：只顯示內部行。
* 若 (內=0, 外>0)：只顯示外部行。
* 若 (內=0, 外=0)：顯示「請準備感謝詞」。


* **金額區塊：**
* 若 (金額 > 10,000)：顯示金額行。
* 若 (金額 <= 10,000)：隱藏金額行。


* **121區塊：** 永遠隱藏。

**【最終訊息範本】**

```text
【引薦回報完成確認】
回報人：暖樺

本週內部引薦：2 張 (給：張大為)
外部引薦：1 張 (給：禮盒)
金額：$12,500

系統已自動更新數據。若需修改，請重新填寫即可覆蓋舊紀錄。

```

---

### 5.4 組長管理功能細節

#### A. 【本週已回報】(詳細清單)

系統讀取當週分頁所有資料，回傳格式如下：

> **【本週已回報詳情】**
> **1. 暖樺**
> 內部引薦：2 張 (給：張大為)
> 外部引薦：0 張 (給：/)
> 內外總金額：$4,050 | 121：0 次
> **2. 佳馨**
> 內部引薦：3 張 (給：浩倫)
> ...

#### B. 【本週未回報】(簡易名單)

系統比對 `Member_List` 與 當週分頁名單，找出缺席者：

> **【本週未回報名單】**
> 許銘浚、蔡嘉瑋、李立武。

#### C. 【雲端總覽】

開啟 Google Sheets URL。

---

## 6. 異常處理

1. **非數字輸入：** 若在張數/金額題輸入中文，機器人回覆：「⚠️ 格式錯誤，請輸入半形數字（例如：2）。」並重複該問題。
2. **未綁定操作：** 若未綁定用戶透過其他方式觸發回報功能，強制引導至綁定流程。

