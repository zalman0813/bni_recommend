# Shioaji Trading API Expertise
# Python Trading API for Taiwan Financial Markets (SinoPac Securities)

overview:
  description: "Python trading API for Taiwan stocks, futures, and options markets"
  provider: "SinoPac Securities (永豐金證券)"
  package: "shioaji"
  documentation: "https://sinotrade.github.io/"
  github: "https://github.com/Sinotrade/Shioaji"
  architecture: "Event-driven with async support, C++ core with FPGA acceleration"

installation:
  pip: "pip install shioaji"
  uv: "uv pip install shioaji"
  docker: "docker pull sinotrade/shioaji"
  requirements:
    - "Python 3.7+"
    - "Windows, macOS, or Linux"
    - "SinoPac Securities account"
    - "API credentials (api_key, secret_key)"
    - "CA certificate for order placement"

authentication:
  initialization:
    code: "api = sj.Shioaji()"

  login_v1_token_based:
    description: "Recommended for version >= 1.0"
    parameters:
      - "api_key (str): Authentication identifier"
      - "secret_key (str): Authentication secret"
      - "fetch_contract (bool): Load contracts (default: True)"
      - "contracts_timeout (int): Timeout in ms (default: 0)"
      - "subscribe_trade (bool): Auto-subscribe to order/deal events (default: True)"
      - "receive_window (int): Valid login duration in ms (default: 30000)"
    example: |
      api.login(api_key="YOUR_API_KEY", secret_key="YOUR_SECRET_KEY")

  login_legacy:
    description: "For version < 1.0"
    parameters:
      - "person_id (str): Account identifier"
      - "passwd (str): Account password"
      - "hashed (bool): Whether password is pre-hashed (default: False)"
    example: |
      api.login(person_id="YOUR_ID", passwd="YOUR_PASSWORD")

  ca_activation:
    description: "Required for order placement"
    parameters:
      - "ca_path (str): Path to certificate.pfx (use forward slashes)"
      - "ca_passwd (str): Certificate password"
      - "person_id (str): Account person ID"
    example: |
      api.activate_ca(ca_path="C:/path/to/cert.pfx", ca_passwd="PASSWORD", person_id="ID")
    notes:
      - "Convert Windows backslashes to forward slashes"
      - "Required before placing any orders"

  logout: "api.logout()"

account_management:
  list_accounts: "accounts = api.list_accounts()"
  set_default: "api.set_default_account(accounts[0])"
  stock_account: "api.stock_account"
  futopt_account: "api.futopt_account"
  trade_subscription:
    subscribe: "api.subscribe_trade(account)"
    unsubscribe: "api.unsubscribe_trade(account)"

contracts:
  access_pattern: "api.Contracts.{Exchange}.{Symbol}"
  stock_examples:
    - "api.Contracts.Stocks.TSE.TSE2330  # TSMC"
    - "api.Contracts.Stocks['2330']  # Shorthand"
  futures_example: "api.Contracts.Futures.TXF.TXFR1  # Taiwan Index Futures"
  options_example: "api.Contracts.Options.TXO  # Taiwan Index Options"

order_placement:
  order_attributes:
    price: "float/int - Order price"
    quantity: "int - Order quantity (lots for Common, shares for Odd)"
    action: "Action.Buy or Action.Sell"
    price_type: "StockPriceType.LMT/MKT/MKP"
    order_type: "OrderType.ROD/IOC/FOK"
    order_cond: "StockOrderCond.Cash/MarginTrading/ShortSelling"
    order_lot: "StockOrderLot.Common/Fixing/Odd/IntradayOdd"
    daytrade_short: "bool - Day trade short sell (sell first)"
    first_sell: "bool - Day trade sell (buy first then sell)"
    custom_field: "str - Custom identifier (max 6 alphanumeric)"
    account: "Account object"

  constants:
    action:
      - "sj.constant.Action.Buy"
      - "sj.constant.Action.Sell"
    price_type:
      - "sj.constant.StockPriceType.LMT  # Limit order"
      - "sj.constant.StockPriceType.MKT  # Market order"
      - "sj.constant.StockPriceType.MKP  # Range market order"
    order_type:
      - "sj.constant.OrderType.ROD  # Rest of Day"
      - "sj.constant.OrderType.IOC  # Immediate or Cancel"
      - "sj.constant.OrderType.FOK  # Fill or Kill"
    order_cond:
      - "sj.constant.StockOrderCond.Cash  # Cash"
      - "sj.constant.StockOrderCond.MarginTrading  # Margin"
      - "sj.constant.StockOrderCond.ShortSelling  # Short"
    order_lot:
      - "sj.constant.StockOrderLot.Common  # Regular lots (1 lot = 1000 shares)"
      - "sj.constant.StockOrderLot.Fixing  # Fixing session"
      - "sj.constant.StockOrderLot.Odd  # After-hours odd lot"
      - "sj.constant.StockOrderLot.IntradayOdd  # Intraday odd lot"

  place_order:
    basic: |
      order = api.Order(
          price=100, quantity=1,
          action=sj.constant.Action.Buy,
          price_type=sj.constant.StockPriceType.LMT,
          order_type=sj.constant.OrderType.ROD,
          order_cond=sj.constant.StockOrderCond.Cash,
          order_lot=sj.constant.StockOrderLot.Common,
          account=api.stock_account
      )
      trade = api.place_order(contract, order)
    market_order: |
      order = api.MarketOrder(action=sj.constant.Action.Buy, quantity=1)
      trade = api.place_order(contract, order)
    limit_order: |
      order = api.LimitOrder(action=sj.constant.Action.Sell, price=100, quantity=1)
      trade = api.place_order(contract, order)

  order_modification:
    update_price: "api.update_order(trade=trade, price=105)"
    reduce_quantity: "api.update_order(trade=trade, qty=1)"
    notes:
      - "Can only reduce quantity, not increase"
      - "Cannot change price and quantity simultaneously"

  cancel_order: "api.cancel_order(trade)"

  order_status:
    update: "api.update_status(api.stock_account)"
    list_trades: "trades = api.list_trades()"
    status_types:
      - "PendingSubmit - Waiting to submit"
      - "PreSubmitted - Pre-submitted"
      - "Submitted - Submitted"
      - "Failed - Failed"
      - "Cancelled - Cancelled"
      - "Filled - Fully filled"
      - "PartFilled - Partially filled"

  trade_object:
    description: "Returned by place_order()"
    attributes:
      - "trade.contract - Contract information"
      - "trade.order - Order information"
      - "trade.status - Order status"

market_data:
  realtime_subscription:
    method: "api.quote.subscribe(contract, quote_type, intraday_odd=False, version='v1')"
    quote_types:
      tick: "Real-time trade data (price, volume, tick_type)"
      bidask: "5-level bid/ask depth"
      quote: "Combined tick + bidask data"
    unsubscribe: "api.quote.unsubscribe(contract, quote_type, version='v1')"

  callbacks:
    tick_decorator: |
      @api.on_tick_stk_v1()
      def tick_cb(exchange, tick):
          print(f"{tick.code}: {tick.close}")
    bidask_decorator: |
      @api.on_bidask_stk_v1()
      def bidask_cb(exchange, bidask):
          print(f"Bid: {bidask.bid_price[0]} Ask: {bidask.ask_price[0]}")
    quote_decorator: |
      @api.on_quote_stk_v1()
      def quote_cb(exchange, quote):
          print(f"{quote.code}: {quote.close}")

  tick_data_structure:
    fields:
      - "code, datetime"
      - "open, high, low, close"
      - "volume, total_volume"
      - "amount, total_amount"
      - "tick_type: 1=external (buyer), 2=internal (seller)"
      - "chg_type: 1=limit up, 2=up, 3=unchanged, 4=down, 5=limit down"
      - "price_chg, pct_chg"
      - "bid_side_total_vol, ask_side_total_vol"
      - "bid_side_total_cnt, ask_side_total_cnt"
      - "suspend: Trading suspension flag"

  bidask_data_structure:
    fields:
      - "bid_price[0-4]: 5 levels of bid prices"
      - "bid_volume[0-4]: 5 levels of bid volumes"
      - "ask_price[0-4]: 5 levels of ask prices"
      - "ask_volume[0-4]: 5 levels of ask volumes"
      - "diff_bid_vol[0-4]: Volume changes per level"
      - "diff_ask_vol[0-4]: Volume changes per level"

  historical_data:
    ticks:
      method: "api.ticks(contract, date='', query_type=..., time_start='', time_end='', last_cnt=0)"
      examples:
        - "api.ticks(contract, date='2025-12-23')  # All ticks for date"
        - "api.ticks(contract, date='2025-12-23', time_start='09:00:00', time_end='12:00:00')  # Time range"
        - "api.ticks(contract, last_cnt=100)  # Last N ticks"
    kbars:
      method: "api.kbars(contract, start='YYYY-MM-DD', end='YYYY-MM-DD')"
      fields: "ts, Open, High, Low, Close, Volume"
    data_availability:
      stocks: "From March 2, 2020"
      futures: "From March 22, 2020"

  snapshots:
    method: "api.snapshots(contracts, timeout=30000)"
    max_contracts: 500
    fields:
      - "ts, code, exchange"
      - "open, high, low, close, avg_price"
      - "change_price, change_rate, change_type"
      - "volume, total_volume, yesterday_volume, volume_ratio"
      - "buy_price, buy_volume, sell_price, sell_volume"
      - "tick_type, amount, total_amount"

account_queries:
  margin: "api.get_account_margin()"
  positions: "api.get_account_openposition()"
  settled_pnl: "api.get_account_settle_profitloss()"

common_patterns:
  complete_workflow: |
    import shioaji as sj

    # Initialize and login
    api = sj.Shioaji()
    api.login(api_key="KEY", secret_key="SECRET")

    # Activate CA for trading
    api.activate_ca(ca_path="path/to/cert.pfx", ca_passwd="PASS", person_id="ID")

    # Get contract
    contract = api.Contracts.Stocks['2330']

    # Subscribe to market data
    @api.on_tick_stk_v1()
    def on_tick(exchange, tick):
        print(f"{tick.code}: {tick.close}")
    api.quote.subscribe(contract, quote_type=sj.constant.QuoteType.Tick, version='v1')

    # Place order
    order = api.Order(
        price=600, quantity=1,
        action=sj.constant.Action.Buy,
        price_type=sj.constant.StockPriceType.LMT,
        order_type=sj.constant.OrderType.ROD,
        account=api.stock_account
    )
    trade = api.place_order(contract, order)

    # Cleanup
    api.logout()

  day_trading:
    buy_first_then_sell: "first_sell=True in sell order"
    sell_first_then_buy: "daytrade_short=True in sell order"

  odd_lot_trading:
    after_hours: "order_lot=sj.constant.StockOrderLot.Odd"
    intraday: "order_lot=sj.constant.StockOrderLot.IntradayOdd"
    note: "Quantity is in shares, not lots"

important_notes:
  - "Time sync: Ensure system time is synchronized to avoid 'Sign data is timeout' errors"
  - "CA required: Must activate CA certificate before placing orders"
  - "Lot vs shares: Common lot = 1000 shares, odd lot quantity is in shares"
  - "Modify limits: Can only reduce quantity, cannot change price and qty together"
  - "API version: Use token-based login for v1.0+, use v1 quote format"
  - "Timestamps: All in Taiwan timezone (UTC+8)"

documentation_files:
  local_ai_docs:
    - "ai_docs/shioaji-overview.md - API overview and features"
    - "ai_docs/shioaji-quickstart.md - Quick start guide"
    - "ai_docs/shioaji-stock-order.md - Stock order placement details"
    - "ai_docs/shioaji-market-data.md - Market data streaming and historical data"
